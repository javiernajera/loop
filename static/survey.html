<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loop — compatibility survey</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Background + shimmer styles (same as index) -->
  <style>
    body {
      background-image: url('/assets/loop-background.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }

    @media (max-width: 640px) {
      body { background-attachment: scroll; }
    }

    /* Loop shimmer (same as index) */
    .loop-shimmer {
      display: inline-block;
      font-weight: 600;
      letter-spacing: 0.18em;
      color: transparent;
      background-image: linear-gradient(
        110deg,
        #b0892f 0%,
        #f3f4f6 20%,
        #bfc5cc 40%,
        #f5d77a 60%,
        #d1d5db 80%,
        #b0892f 100%
      );
      background-size: 250% 100%;
      background-position: 0% 50%;
      -webkit-background-clip: text;
      background-clip: text;
      animation: shimmer 4.5s linear infinite;
      text-shadow: 0 0 1px rgba(0,0,0,0.15);
    }

    @keyframes shimmer {
      0%   { background-position: 0% 50%; }
      100% { background-position: 200% 50%; }
    }

    @media (prefers-reduced-motion: reduce) {
      .loop-shimmer { animation: none; }
    }
  </style>
</head>

<body class="min-h-screen text-stone-900 antialiased">

  <!-- Soft paper overlay -->
  <div class="min-h-screen bg-stone-50/70 backdrop-blur-sm">
    <div class="max-w-3xl mx-auto px-6 py-20">

      <!-- Header -->
      <header class="mb-14">
        <div class="flex items-center justify-between mb-8">
          <p class="uppercase tracking-widest text-xs text-stone-500">
            <span class="loop-shimmer">Loop</span>
          </p>
          <a href="/faq.html" class="text-sm underline text-stone-600 hover:text-stone-900">
            FAQ
          </a>
        </div>

        <h1 class="text-4xl md:text-5xl font-semibold leading-tight mb-4">
          Quick compatibility survey
        </h1>

        <p class="text-lg text-stone-600 max-w-2xl">
          We use this to introduce you to a local musician who’s a good fit to collaborate with.
          No photos. No feeds. One email per week.
        </p>

        <p class="text-sm text-stone-500 mt-3">
          Takes ~2–3 minutes.
        </p>
      </header>

      <!-- Survey Card -->
      <section class="bg-white/80 border border-stone-200 rounded-xl p-6 md:p-8 shadow-sm">
        <p id="statusMsg" class="mb-4 text-sm text-stone-600"></p>

        <form id="surveyForm" class="space-y-8">

          <!-- Essentials -->
          <div>
            <h2 class="text-lg font-medium mb-2">2-minute collab survey</h2>
            <p class="text-sm text-stone-500 mb-6">
              We only ask what we use to match you. No photos, no socials, no feed.
            </p>
        
            <!-- Name (optional) -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-stone-700 mb-1">First name (optional)</label>
              <input name="firstName" type="text" placeholder="e.g. Javier"
                class="w-full px-4 py-3 rounded-md border border-stone-300 focus:outline-none focus:ring-2 focus:ring-stone-400" />
            </div>
        
            <!-- Genres (required) -->
            <div class="mb-6">
              <div class="flex items-baseline justify-between gap-3">
                <label class="block text-sm font-medium text-stone-700 mb-1">
                  Your main genres <span class="text-stone-500">(pick up to 4)</span>
                </label>
                <p class="text-xs text-stone-500" id="genresHint">0 / 4 selected</p>
              </div>
        
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-2" id="genresWrap">
                <!-- Keep this list broad; search can come later -->
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="hip_hop" class="rounded border-stone-300" />
                  Hip-hop / Rap
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="rnb" class="rounded border-stone-300" />
                  R&amp;B / Soul
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="pop" class="rounded border-stone-300" />
                  Pop
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="indie" class="rounded border-stone-300" />
                  Indie
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="rock" class="rounded border-stone-300" />
                  Rock
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="electronic" class="rounded border-stone-300" />
                  Electronic
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="house" class="rounded border-stone-300" />
                  House
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="techno" class="rounded border-stone-300" />
                  Techno
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="latin" class="rounded border-stone-300" />
                  Latin
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="reggaeton" class="rounded border-stone-300" />
                  Reggaeton
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="afrobeats" class="rounded border-stone-300" />
                  Afrobeats
                </label>
                <label class="flex items-center gap-2 text-sm text-stone-700">
                  <input type="checkbox" name="genres" value="experimental" class="rounded border-stone-300" />
                  Experimental
                </label>
              </div>
        
              <div class="mt-3">
                <label class="block text-sm font-medium text-stone-700 mb-1">Other genre (optional)</label>
                <input name="genre_other" type="text" placeholder="e.g. Lo-fi, Soundtrack, Jazz fusion"
                  class="w-full px-4 py-3 rounded-md border border-stone-300 focus:outline-none focus:ring-2 focus:ring-stone-400" />
              </div>
        
              <label class="mt-3 flex items-center gap-2 text-sm text-stone-700">
                <input type="checkbox" name="open_to_adjacent" value="yes" class="rounded border-stone-300" />
                I’m open to adjacent genres
              </label>
            </div>
        
            <!-- Goal (required) -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-stone-700 mb-1">What are you looking for right now?</label>
              <select name="collab_goal" required
                class="w-full px-4 py-3 rounded-md border border-stone-300 focus:outline-none focus:ring-2 focus:ring-stone-400 bg-white">
                <option value="">Select…</option>
                <option value="write_together">Write together</option>
                <option value="produce">Production help / co-produce</option>
                <option value="feature_swap">Feature swaps</option>
                <option value="jam_explore">Jam + explore ideas</option>
                <option value="finish_tracks">Finish tracks</option>
              </select>
            </div>
        
            <!-- Commitment signal (required) -->
            <div class="mb-6">
              <label class="block text-sm font-medium text-stone-700 mb-1">
                How active are you in the next 4 weeks?
              </label>
              <select name="availability_window" required
                class="w-full px-4 py-3 rounded-md border border-stone-300 focus:outline-none focus:ring-2 focus:ring-stone-400 bg-white">
                <option value="">Select…</option>
                <option value="ready_now">Ready now (this month)</option>
                <option value="somewhat_active">Somewhat active (1–2 sessions)</option>
                <option value="browsing">Browsing / not sure yet</option>
              </select>
              <p class="text-xs text-stone-500 mt-2">
                This helps us match you with someone on a similar rhythm.
              </p>
            </div>
        
            <!-- Connection style (required) -->
            <div class="mb-2">
              <label class="block text-sm font-medium text-stone-700 mb-1">What usually feels best when collaborating?</label>
              <select name="connection_style" required
                class="w-full px-4 py-3 rounded-md border border-stone-300 focus:outline-none focus:ring-2 focus:ring-stone-400 bg-white">
                <option value="">Select…</option>
                <option value="structured">Structured sessions</option>
                <option value="thoughtful_back_and_forth">Thoughtful back-and-forth</option>
                <option value="creative_exchange">Deep creative exchange</option>
                <option value="practical_problem_solving">Practical problem-solving</option>
                <option value="open_ended_wandering">Open-ended wandering</option>
                <option value="depends">Depends on the moment</option>
              </select>
            </div>
          </div>
        
          <!-- Optional (collapsed) -->
          <details class="bg-stone-50/60 border border-stone-200 rounded-lg p-4">
            <summary class="cursor-pointer text-sm font-medium text-stone-700">
              Optional: improve your match <span class="text-stone-500">(30 seconds)</span>
            </summary>
        
            <div class="mt-4 space-y-5">
              <!-- Roles (optional, pick up to 2) -->
              <div>
                <div class="flex items-baseline justify-between gap-3">
                  <label class="block text-sm font-medium text-stone-700 mb-1">
                    What do you bring? <span class="text-stone-500">(pick up to 2)</span>
                  </label>
                  <p class="text-xs text-stone-500" id="rolesHint">0 / 2 selected</p>
                </div>
        
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-2" id="rolesWrap">
                  <label class="flex items-center gap-2 text-sm text-stone-700">
                    <input type="checkbox" name="roles" value="vocals" class="rounded border-stone-300" />
                    Vocals
                  </label>
                  <label class="flex items-center gap-2 text-sm text-stone-700">
                    <input type="checkbox" name="roles" value="producer" class="rounded border-stone-300" />
                    Producer
                  </label>
                  <label class="flex items-center gap-2 text-sm text-stone-700">
                    <input type="checkbox" name="roles" value="guitar" class="rounded border-stone-300" />
                    Guitar
                  </label>
                  <label class="flex items-center gap-2 text-sm text-stone-700">
                    <input type="checkbox" name="roles" value="keys" class="rounded border-stone-300" />
                    Keys / synth
                  </label>
                  <label class="flex items-center gap-2 text-sm text-stone-700">
                    <input type="checkbox" name="roles" value="drums" class="rounded border-stone-300" />
                    Drums
                  </label>
                  <label class="flex items-center gap-2 text-sm text-stone-700">
                    <input type="checkbox" name="roles" value="mixing" class="rounded border-stone-300" />
                    Mixing / engineering
                  </label>
                </div>
              </div>
        
              <div>
                <label class="block text-sm font-medium text-stone-700 mb-1">Anything to avoid? (optional)</label>
                <input name="avoidances" type="text" placeholder="e.g. super late sessions, heavy drinking environments…"
                  class="w-full px-4 py-3 rounded-md border border-stone-300 focus:outline-none focus:ring-2 focus:ring-stone-400" />
              </div>
        
              <!-- If you truly need “how they found you”, keep it optional -->
              <div>
                <label class="block text-sm font-medium text-stone-700 mb-1">How did you find Loop? (optional)</label>
                <select name="source" class="w-full px-4 py-3 rounded-md border border-stone-300 focus:outline-none focus:ring-2 focus:ring-stone-400 bg-white">
                  <option value="">(optional)</option>
                  <option value="friend">A friend</option>
                  <option value="x">Twitter / X</option>
                  <option value="instagram">Instagram</option>
                  <option value="newsletter">Newsletter / blog</option>
                  <option value="random_link">Random link</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
          </details>
        
          <hr class="border-stone-200" />
        
          <!-- Consent -->
          <div class="flex items-start gap-3">
            <input id="consent" name="consent" type="checkbox" value="yes" required class="mt-1" />
            <label for="consent" class="text-sm text-stone-600">
              I confirm I’m 18+ and I consent to my responses being used to improve matching.
            </label>
          </div>
        
          <!-- Submit -->
          <div class="pt-2">
            <button type="submit"
              class="w-full sm:w-auto px-6 py-3 rounded-md bg-stone-900 text-stone-50 hover:bg-stone-800 transition">
              Submit
            </button>
          </div>
        </form>                
      </section>

      <p class="mt-6 text-sm text-stone-500">
        Questions? <a href="/faq.html" class="underline hover:text-stone-900">Read the FAQ</a>.
      </p>

      <!-- Footer -->
      <footer class="mt-16 border-t border-stone-200 pt-10 text-sm text-stone-600">
        <p>
          <a href="/faq.html" class="underline hover:text-stone-900">FAQ</a> ·
          <a href="mailto:hello@loop.fm" class="underline hover:text-stone-900">hello@loop.fm</a>
        </p>
        <p class="mt-4 text-stone-400">Built for musicians. Slow by design.</p>
      </footer>

    </div>
  </div>
  <script>
    const SURVEY_FUNCTION_URL =
      "https://bqlrerkoqmwfrh3bq6bf5abz7e0pemvy.lambda-url.us-east-1.on.aws/";
  
    const form = document.getElementById("surveyForm");
    const statusMsg = document.getElementById("statusMsg");
  
    const params = new URLSearchParams(window.location.search);
    const token = params.get("token");
    const email = params.get("email") || "";
  
    // desired signals UI helpers
    const signalsHint = document.getElementById("signalsHint");
    const signalsWrap = document.getElementById("signalsWrap");
  
    function getDesiredSignals() {
      return Array.from(document.querySelectorAll('input[name="desired_signals"]:checked'))
        .map(cb => cb.value);
    }
  
    function updateSignalsHint() {
      const n = getDesiredSignals().length;
      if (signalsHint) signalsHint.textContent = `${n} / 2 selected`;
    }
  
    if (signalsWrap) {
      signalsWrap.addEventListener("change", (e) => {
        const selected = getDesiredSignals();
        if (selected.length > 2) {
          // undo last check if we went over 2
          e.target.checked = false;
        }
        updateSignalsHint();
      });
      updateSignalsHint();
    }
  
    console.log("Survey href:", window.location.href);
    console.log("Parsed:", { token, email });
  
    if (!token) {
      statusMsg.textContent = "Missing token. Please use the survey link from your email.";
      form.style.display = "none";
    } else {
      statusMsg.textContent = "";
    }
  
    if (token) {
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
  
        statusMsg.textContent = "Submitting your answers…";
  
        const raw = Object.fromEntries(new FormData(form).entries());
  
        // Convert desired_signals into array
        const desired_signals = getDesiredSignals();
        if (desired_signals.length === 0) {
          statusMsg.textContent = "Pick at least 1 signal (up to 2).";
          return;
        }
        if (desired_signals.length > 2) {
          statusMsg.textContent = "Pick up to 2 signals.";
          return;
        }
  
        // Optional: normalize empty strings to nulls (keeps Dynamo cleaner)
        function nullify(v) {
          if (v === undefined || v === null) return null;
          const s = String(v).trim();
          return s === "" ? null : s;
        }
  
        const answers = {
          firstName: nullify(raw.firstName),
          source: raw.source,
          pause_reason: nullify(raw.pause_reason),
          orientation: raw.orientation,
          desired_signals,
          cadence: raw.cadence,
          attention_bias: nullify(raw.attention_bias),
          connection_style: raw.connection_style,
          anti_signal: nullify(raw.anti_signal),
          never_forget: nullify(raw.never_forget),
          consent: raw.consent === "yes",
          submitted_at: new Date().toISOString()
        };
  
        try {
          const res = await fetch(SURVEY_FUNCTION_URL, {
            method: "POST",
            mode: "cors",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, email, answers })
          });
  
          const text = await res.text();
          let data = {};
          try { data = text ? JSON.parse(text) : {}; } catch { data = {}; }
  
          if (!res.ok || data.ok === false) {
            statusMsg.textContent = data.error || data.message || `Server error (${res.status})`;
            console.error("Survey submit failed:", { status: res.status, text, data });
            return;
          }
  
          window.location.href = "/thanks.html";
        } catch (err) {
          console.error(err);
          statusMsg.textContent = `Network error: ${err?.message || err}`;
        }
      });
    }
  </script>  
</body>
</html>
